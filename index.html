
<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
  <title>Qura Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#000;
      --panel: rgba(18,18,18,0.98);
      --input:#1a1a1a;
      --border:#222;
      --muted:#a1a1aa;
      --grad: linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);
      --max:600px;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{
      margin:0;background:#050505;font-family:'Plus Jakarta Sans',sans-serif;color:#fff;
      height:100dvh;overflow:hidden;display:flex;flex-direction:column;
    }
    #app{width:100%;height:100%;margin:0 auto;background:var(--bg);position:relative;display:flex;flex-direction:column;}
    @media(min-width:768px){#app{max-width:var(--max);border-left:1px solid var(--border);border-right:1px solid var(--border);}}

    /* header */
    #header{
      position:absolute;top:0;left:0;right:0;z-index:50;
      padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;backdrop-filter:blur(10px);
    }
    .hl{display:flex;align-items:center;gap:10px;cursor:pointer;flex:1;overflow:hidden;}
    .back{color:var(--muted);display:flex;align-items:center;padding:5px;}
    .avatar{
      width:34px;height:34px;border-radius:50%;
      background:linear-gradient(45deg,#ff00cc,#333399);
      display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;flex-shrink:0;overflow:hidden;
    }
    #avatarPhoto{width:34px;height:34px;border-radius:50%;object-fit:cover;display:none;flex-shrink:0;}
    .ui{display:flex;flex-direction:column;overflow:hidden}
    #title{font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{font-size:11px;color:#6366f1}
    .ha{display:flex;gap:6px}
    .hb{width:34px;height:34px;border-radius:50%;border:none;background:rgba(255,255,255,0.05);color:var(--muted);cursor:pointer}

    /* messages */
    #msgs{
      flex:1;overflow-y:auto;scroll-behavior:smooth;
      padding:15px;padding-top:70px;padding-bottom:78px;
      display:flex;flex-direction:column;gap:10px;
    }
    .row{display:flex;width:100%}
    .row.mine{justify-content:flex-end}
    .row.theirs{justify-content:flex-start}
    .bubble{
      max-width:85%;padding:10px 14px;border-radius:18px;font-size:15px;line-height:1.4;
      background:#27272a;color:#fff;
    }
    .mine .bubble{background:var(--grad);border-bottom-right-radius:2px}
    .theirs .bubble{border-bottom-left-radius:2px}
    .t{display:block;font-size:10px;opacity:.7;text-align:right;margin-top:6px}

    /* input */
    #input{
      position:absolute;left:0;right:0;bottom:0;z-index:50;
      padding:8px 10px;padding-bottom:max(8px, env(safe-area-inset-bottom));
      background:var(--panel);border-top:1px solid var(--border);
      display:flex;align-items:center;gap:8px;
    }
    .wrap{
      flex:1;min-width:0;display:flex;align-items:center;
      background:var(--input);border:1px solid #333;border-radius:24px;padding:8px 12px;min-height:40px;
    }
    #txt{flex:1;min-width:0;background:transparent;border:none;outline:none;color:#fff;font-size:16px}
    #send{
      width:38px;height:38px;border-radius:50%;border:none;cursor:pointer;flex-shrink:0;
      background:var(--grad);display:flex;align-items:center;justify-content:center;
    }

    /* login screen */
    #loginOverlay{
      position:fixed;inset:0;z-index:999;display:none;
      background:rgba(0,0,0,.86);backdrop-filter:blur(8px);
      align-items:center;justify-content:center;padding:20px;
    }
    .card{
      width:100%;max-width:420px;background:#121212;border:1px solid #333;border-radius:20px;
      padding:22px;box-shadow:0 20px 60px rgba(0,0,0,.6);
    }
    .h1{font-size:18px;font-weight:800;margin:0 0 6px 0}
    .p{margin:0 0 16px 0;color:#aaa;font-size:13px;line-height:1.4}
    .field{
      width:100%;background:#1a1a1a;border:1px solid #333;border-radius:12px;
      padding:12px 12px;color:#fff;font-size:15px;outline:none;
    }
    .btn{
      margin-top:12px;width:100%;border:none;border-radius:14px;
      padding:14px 12px;font-weight:800;cursor:pointer;background:var(--grad);color:#fff;font-size:15px;
    }
    .mini{
      margin-top:10px;color:#777;font-size:12px;line-height:1.4;
    }
    .link{
      color:#8b5cf6;text-decoration:underline;cursor:pointer;
    }

    /* tiny toast */
    #toast{
      position:fixed;left:50%;bottom:95px;transform:translateX(-50%);
      background:#151515;border:1px solid #333;color:#ddd;
      padding:10px 12px;border-radius:12px;z-index:1000;display:none;font-size:13px;
      max-width:92vw;
    }
  </style>
</head>
<body>

<div id="app">
  <div id="header">
    <div class="hl" id="profileLink">
      <div class="back">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </div>

      <img id="avatarPhoto" alt="avatar">
      <div class="avatar" id="avatarChar">?</div>

      <div class="ui">
        <div id="title">...</div>
        <div class="sub">Переглянути профіль</div>
      </div>
    </div>

    <div class="ha">
      <button class="hb" id="whoBtn" title="Хто я?">i</button>
    </div>
  </div>

  <div id="msgs"></div>

  <div id="input">
    <div class="wrap">
      <input id="txt" type="text" placeholder="Повідомлення..." autocomplete="off">
    </div>
    <button id="send" title="Send">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
        <rect x="2" y="4" width="20" height="16" rx="2" />
        <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" />
      </svg>
    </button>
  </div>
</div>

<div id="loginOverlay">
  <div class="card">
    <div class="h1">Вхід у чат</div>
    <div class="p">Введи свій email (на старті це заміна “логіну”). Ми збережемо його, щоб не вводити щоразу.</div>
    <input class="field" id="loginEmail" type="email" placeholder="Напр. admin@test.com">
    <button class="btn" id="loginBtn">Продовжити</button>
    <div class="mini">
      Потім можна зробити нормальний вхід через Google. Зараз головне — щоб чат працював стабільно.
      <br><span class="link" id="resetMe">Скинути збережений email</span>
    </div>
  </div>
</div>

<div id="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, limit, serverTimestamp,
    doc, getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBQNxVaRBgyiM0oJJjzDJ5MJi1WBVPlsdI",
    authDomain: "quradating777.firebaseapp.com",
    projectId: "quradating777",
    storageBucket: "quradating777.firebasestorage.app",
    messagingSenderId: "723638199684",
    appId: "1:723638199684:web:b00ea1895fd5b7ee63e9d1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // -------- URL params from Softr button ----------
  const params = new URLSearchParams(window.location.search);

  // partnerId MUST come from Softr: ?partnerId=4
  const partnerId = (params.get("partnerId") || "").trim();
  // partnerEmail MUST come from Softr: ?partnerEmail=user@test.com
  const partnerEmail = (params.get("partnerEmail") || "").trim();

  // myEmail comes from localStorage OR from URL ?me=...
  const storedMe = (localStorage.getItem("qura_me_email") || "").trim();
  const urlMe = (params.get("me") || "").trim();
  let myEmail = urlMe || storedMe;

  // UI
  const titleEl = document.getElementById("title");
  const avatarChar = document.getElementById("avatarChar");
  const avatarPhoto = document.getElementById("avatarPhoto");
  const msgs = document.getElementById("msgs");
  const input = document.getElementById("txt");
  const sendBtn = document.getElementById("send");
  const loginOverlay = document.getElementById("loginOverlay");
  const loginEmail = document.getElementById("loginEmail");
  const loginBtn = document.getElementById("loginBtn");
  const toast = document.getElementById("toast");

  // -------- helpers ----------
  function showToast(text){
    toast.textContent = text;
    toast.style.display = "block";
    clearTimeout(window.__toastT);
    window.__toastT = setTimeout(()=>toast.style.display="none", 2600);
  }

  function looksUnsubstituted(v){
    return v.includes("{") || v.includes("}");
  }

  function esc(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function requirePartnerParams(){
    if(!partnerId || !partnerEmail || looksUnsubstituted(partnerId) || looksUnsubstituted(partnerEmail)){
      alert(
        "Проблема з URL з Softr (параметри не підставились).\n\n" +
        "Потрібно: ?partnerId=4&partnerEmail=user@test.com\n\n" +
        "Зараз: " + window.location.href
      );
      titleEl.textContent = "Немає даних";
      avatarChar.textContent = "!";
      throw new Error("Bad partner params");
    }
  }

  function ensureMyEmail(){
    if(!myEmail || looksUnsubstituted(myEmail)){
      loginOverlay.style.display = "flex";
      loginEmail.value = "";
      loginEmail.focus();
      return false;
    }
    return true;
  }

  // -------- Partner header (name/photo) ----------
  async function loadPartner(){
    try{
      const ref = doc(db, "users", String(partnerId));
      const snap = await getDoc(ref);

      if(!snap.exists()){
        titleEl.textContent = "User " + partnerId;
        avatarChar.textContent = String(partnerId)[0]?.toUpperCase() || "?";
        return;
      }

      const u = snap.data() || {};
      const displayName = (u.name || ("User " + partnerId)).trim();
      titleEl.textContent = displayName;
      avatarChar.textContent = displayName.charAt(0).toUpperCase();

      if(u.photo){
        avatarPhoto.src = u.photo;
        avatarPhoto.style.display = "block";
        avatarChar.style.display = "none";

        // якщо картинка не завантажилась — повернемо літеру
        avatarPhoto.onerror = () => {
          avatarPhoto.style.display = "none";
          avatarChar.style.display = "flex";
          showToast("Фото не відкривається по URL. Потрібен прямий лінк на картинку.");
        };
      } else {
        avatarPhoto.style.display = "none";
        avatarChar.style.display = "flex";
      }

    } catch(e){
      console.error(e);
      showToast("Не вдалося завантажити профіль партнера з Firestore.");
      titleEl.textContent = "User " + partnerId;
      avatarChar.textContent = String(partnerId)[0]?.toUpperCase() || "?";
    }
  }

  // -------- Chat (history + send) ----------
  function initChat(){
    // читаємо останні 100 повідомлень, де є мій email, і фільтруємо по partnerEmail
    const q = query(
      collection(db, "messages"),
      where("participants", "array-contains", myEmail),
      orderBy("createdAt", "asc"),
      limit(100)
    );

    onSnapshot(q, (snapshot) => {
      msgs.innerHTML = "";
      snapshot.forEach((d) => {
        const m = d.data() || {};
        if(Array.isArray(m.participants) && m.participants.includes(partnerEmail)){
          renderMsg(m);
        }
      });
      setTimeout(()=>{ msgs.scrollTop = msgs.scrollHeight; }, 50);
    }, (err) => {
      console.error(err);
      alert("Помилка читання історії (Firestore rules/доступ): " + err.message);
    });

    sendBtn.onclick = sendMessage;
    input.onkeypress = (e) => { if(e.key === "Enter") sendMessage(); };
  }

  function renderMsg(m){
    const row = document.createElement("div");
    row.className = "row " + (m.sender === myEmail ? "mine" : "theirs");

    const time = m.createdAt ? new Date(m.createdAt.toDate()).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}) : "";
    row.innerHTML = `<div class="bubble">${esc(m.text||"")}<span class="t">${time}</span></div>`;
    msgs.appendChild(row);
  }

  async function sendMessage(){
    const text = (input.value || "").trim();
    if(!text) return;

    input.value = "";

    try{
      await addDoc(collection(db, "messages"), {
        text,
        sender: myEmail,
        participants: [myEmail, partnerEmail], // ✅ симетрично для двох
        createdAt: serverTimestamp()
      });
    } catch(e){
      console.error(e);
      alert("Не вдалося відправити (Firestore rules/доступ): " + e.message);
    }
  }

  // -------- Login overlay actions ----------
  loginBtn.onclick = () => {
    const v = (loginEmail.value || "").trim().toLowerCase();
    if(!v || !v.includes("@")){
      showToast("Введи коректний email");
      return;
    }
    myEmail = v;
    localStorage.setItem("qura_me_email", myEmail);
    loginOverlay.style.display = "none";
    showToast("Готово. Ти увійшов як: " + myEmail);
    initChat();
  };

  document.getElementById("resetMe").onclick = () => {
    localStorage.removeItem("qura_me_email");
    myEmail = "";
    showToast("Збережений email стерто");
  };

  document.getElementById("whoBtn").onclick = () => {
    alert("Ти зараз як: " + (myEmail || "(не задано)"));
  };

  // -------- Start ----------
  requirePartnerParams();
  await loadPartner();

  if(ensureMyEmail()){
    initChat();
  }
</script>
</body>
</html>
