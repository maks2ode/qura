<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
  <title>Qura Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #000000;
      --header-bg: rgba(18, 18, 18, 0.98);
      --input-bg: #1a1a1a;
      --brand-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      --text-primary: #ffffff;
      --text-secondary: #a1a1aa;
      --app-max-width: 600px;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; background: #050505; font-family: 'Plus Jakarta Sans', sans-serif;
      color: var(--text-primary); display: flex; flex-direction: column; height: 100dvh; overflow: hidden;
    }
    #app-container {
      width: 100%; height: 100%; display: flex; flex-direction: column; background: var(--bg-color);
      position: relative; margin: 0 auto;
    }
    @media (min-width: 768px) {
      #app-container { max-width: var(--app-max-width); border-left: 1px solid #222; border-right: 1px solid #222; }
    }

    #header {
      padding: 10px 12px; background: var(--header-bg); border-bottom: 1px solid #222;
      display: flex; align-items: center; justify-content: space-between;
      z-index: 50; position: absolute; top: 0; left: 0; right: 0; backdrop-filter: blur(10px);
    }
    .header-left { display: flex; align-items: center; gap: 10px; cursor: pointer; flex: 1; overflow: hidden; }
    .back-btn { color: var(--text-secondary); display: flex; align-items: center; padding: 5px; }

    .avatar-circle {
      width: 34px; height: 34px; background: linear-gradient(45deg, #ff00cc, #333399);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 14px; flex-shrink: 0; overflow: hidden;
    }
    #avatar-photo { width: 34px; height: 34px; border-radius: 50%; object-fit: cover; display:none; }

    .user-info { display: flex; flex-direction: column; overflow: hidden; }
    .user-name { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-status { font-size: 11px; color: #6366f1; }

    .header-actions { display: flex; align-items: center; gap: 5px; }
    .header-btn {
      width: 34px; height: 34px; border-radius: 50%; border: none;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      background: rgba(255,255,255,0.05); color: var(--text-secondary); transition: 0.2s;
    }
    .header-btn:active { transform: scale(0.9); }

    #messages {
      flex: 1; overflow-y: auto; padding: 15px; padding-top: 70px; padding-bottom: 75px;
      display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth;
    }
    .msg-row { display: flex; width: 100%; }
    .msg { max-width: 85%; padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; }
    .mine { justify-content: flex-end; }
    .mine .msg { background: var(--brand-gradient); color: white; border-bottom-right-radius: 2px; }
    .theirs { justify-content: flex-start; }
    .theirs .msg { background: #27272a; color: white; border-bottom-left-radius: 2px; }

    #input-area {
      padding: 8px 10px; padding-bottom: max(8px, env(safe-area-inset-bottom));
      background: var(--header-bg); border-top: 1px solid #222;
      display: flex; align-items: center; gap: 8px; position: absolute; bottom: 0; left: 0; right: 0; z-index: 50;
    }
    .input-wrapper {
      flex: 1; background: var(--input-bg); border-radius: 24px; padding: 8px 12px;
      display: flex; align-items: center; border: 1px solid #333; min-height: 40px; min-width: 0;
    }
    input[type="text"] { flex: 1; background: transparent; border: none; color: white; font-size: 16px; outline: none; min-width: 0; }
    button#send-btn {
      background: var(--brand-gradient); width: 38px; height: 38px; border-radius: 50%; border: none;
      display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
    }
  </style>
</head>
<body>

<div id="app-container">
  <div id="header">
    <div class="header-left" id="profile-link">
      <div class="back-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
      </div>

      <img id="avatar-photo" alt="avatar">
      <div class="avatar-circle" id="avatar-char">?</div>

      <div class="user-info">
        <div class="user-name" id="chat-title">...</div>
        <div class="user-status">Переглянути профіль</div>
      </div>
    </div>

    <div class="header-actions">
      <button class="header-btn" onclick="alert('demo')">⋯</button>
    </div>
  </div>

  <div id="messages"></div>

  <div id="input-area">
    <div class="input-wrapper">
      <input type="text" id="msg-input" placeholder="Повідомлення..." autocomplete="off">
    </div>
    <button id="send-btn">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
        <rect x="2" y="4" width="20" height="16" rx="2" />
        <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" />
      </svg>
    </button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, limit, serverTimestamp,
    doc, getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBQNxVaRBgyiM0oJJjzDJ5MJi1WBVPlsdI",
    authDomain: "quradating777.firebaseapp.com",
    projectId: "quradating777",
    storageBucket: "quradating777.firebasestorage.app",
    messagingSenderId: "723638199684",
    appId: "1:723638199684:web:b00ea1895fd5b7ee63e9d1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const params = new URLSearchParams(window.location.search);

  // ПАРАМЕТРИ, ЯКІ МАЄ ДАТИ SOFTR
  const myEmail = params.get("me");                 // email залогіненого
  const partnerId = params.get("partnerId");        // User ID профілю
  const partnerEmail = params.get("partnerEmail");  // Email профілю

  const chatTitle = document.getElementById("chat-title");
  const avatarChar = document.getElementById("avatar-char");
  const avatarPhoto = document.getElementById("avatar-photo");
  const msgBox = document.getElementById("messages");

  function badParams() {
    return (
      !myEmail || !partnerId || !partnerEmail ||
      myEmail.includes("{") || partnerId.includes("{") || partnerEmail.includes("{")
    );
  }

  if (badParams()) {
    alert(
      "Softr НЕ підставив параметри в URL.\n\n" +
      "Потрібно: ?partnerId=4&partnerEmail=user@test.com&me=admin@test.com\n\n" +
      "Зараз у тебе: " + window.location.href
    );
    chatTitle.innerText = "Немає даних з Softr";
    avatarChar.innerText = "!";
    throw new Error("Bad URL params (Softr variables not substituted).");
  }

  // 1) Завантажуємо ім'я+фото з users/{partnerId}
  async function loadPartner() {
    const ref = doc(db, "users", String(partnerId));
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      chatTitle.innerText = "User " + partnerId;
      avatarChar.innerText = (String(partnerId)[0] || "?").toUpperCase();
      return;
    }

    const u = snap.data();
    const displayName = (u.name || ("User " + partnerId)).trim();

    chatTitle.innerText = displayName;
    avatarChar.innerText = displayName.charAt(0).toUpperCase();

    if (u.photo) {
      avatarPhoto.src = u.photo;
      avatarPhoto.style.display = "block";
      avatarChar.style.display = "none";
    } else {
      avatarPhoto.style.display = "none";
      avatarChar.style.display = "flex";
    }
  }

  // 2) Підписка на історію чату (по participants email+email)
  function initChat() {
    const q = query(
      collection(db, "messages"),
      where("participants", "array-contains", myEmail),
      orderBy("createdAt", "asc"),
      limit(100)
    );

    onSnapshot(q, (snapshot) => {
      msgBox.innerHTML = "";
      snapshot.forEach((d) => {
        const data = d.data();
        // показуємо тільки діалог з partnerEmail
        if (data.participants && data.participants.includes(partnerEmail)) {
          renderMessage(data);
        }
      });
      setTimeout(() => msgBox.scrollTop = msgBox.scrollHeight, 50);
    }, (err) => {
      alert("Помилка читання історії (rules): " + err.message);
      console.error(err);
    });

    document.getElementById("send-btn").onclick = sendMessage;
    document.getElementById("msg-input").onkeypress = (e) => {
      if (e.key === "Enter") sendMessage();
    };
  }

  function renderMessage(data) {
    const row = document.createElement("div");
    row.className = `msg-row ${data.sender === myEmail ? "mine" : "theirs"}`;

    const time = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "";
    row.innerHTML = `<div class="msg">${escapeHtml(data.text || "")}<div style="opacity:.6;font-size:10px;text-align:right;margin-top:6px">${time}</div></div>`;
    msgBox.appendChild(row);
  }

  async function sendMessage() {
    const input = document.getElementById("msg-input");
    const text = (input.value || "").trim();
    if (!text) return;

    input.value = "";

    try {
      await addDoc(collection(db, "messages"), {
        text,
        sender: myEmail,
        participants: [myEmail, partnerEmail], // ✅ симетрично для двох
        createdAt: serverTimestamp()
      });
    } catch (err) {
      alert("Не вдалося відправити (rules/доступ): " + err.message);
      console.error(err);
    }
  }

  function escapeHtml(str) {
    return str.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  // старт
  await loadPartner();
  initChat();
</script>
</body>
</html>
