<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, limit, serverTimestamp,
    doc, getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const SOFTR_PROFILE_URL = "https://quradating.softr.app/user-profile";

  const firebaseConfig = {
    apiKey: "AIzaSyBQNxVaRBgyiM0oJJjzDJ5MJi1WBVPlsdI",
    authDomain: "quradating777.firebaseapp.com",
    projectId: "quradating777",
    storageBucket: "quradating777.firebasestorage.app",
    messagingSenderId: "723638199684",
    appId: "1:723638199684:web:b00ea1895fd5b7ee63e9d1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // --- UI refs
  const chatTitle = document.getElementById('chat-title');
  const avatarChar = document.getElementById('avatar-char');
  const avatarPhoto = document.getElementById('avatar-photo');
  const msgBox = document.getElementById('messages');

  // --- params
  const params = new URLSearchParams(window.location.search);
  const partnerId = params.get('partnerId');         // <-- головний параметр
  let myEmail = params.get('me');                    // може бути від Softr, може не бути

  // --- якщо Softr не передав me=, беремо з localStorage або питаємо 1 раз
  if (!myEmail) {
    myEmail = localStorage.getItem('qura_me_email') || '';
    if (!myEmail) {
      myEmail = prompt("Введи свій email (1 раз, для історії чату):") || '';
      myEmail = myEmail.trim();
    }
    if (myEmail) localStorage.setItem('qura_me_email', myEmail);
  }

  // --- базові перевірки
  if (!partnerId) {
    chatTitle.innerText = "Помилка: нема partnerId";
    avatarChar.innerText = "!";
    disableChat("Нема partnerId у посиланні.");
    throw new Error("Missing partnerId");
  }

  if (!myEmail) {
    chatTitle.innerText = "Потрібен твій email";
    avatarChar.innerText = "?";
    disableChat("Не задано me (твій email).");
    // не throw — можна ввести і перезавантажити
  }

  // --- 1) Авторизація Firebase БЕЗ попапа (Anonymous) щоб rules пропускали
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      await signInAnonymously(auth);
      return;
    }
    // коли вже є auth — запускаєм все інше
    await loadPartnerAndStart();
  });

  async function loadPartnerAndStart() {
    // --- 2) Тягнемо партнера з /users/{partnerId}
    const partnerRef = doc(db, "users", String(partnerId));
    const partnerSnap = await getDoc(partnerRef);

    if (!partnerSnap.exists()) {
      chatTitle.innerText = `Нема users/${partnerId}`;
      avatarChar.innerText = "!";
      disableChat(`Створи документ users/${partnerId} з полями name/photo/email.`);
      return;
    }

    const partner = partnerSnap.data();
    const partnerName = (partner.name || `User ${partnerId}`).toString();
    const partnerEmail = (partner.email || "").toString(); // ВАЖЛИВО для історії/фільтрації
    const partnerPhoto = (partner.photo || "").toString();

    // --- шапка: ім'я
    chatTitle.innerText = partnerName;

    // --- шапка: фото або літера
    setAvatar(partnerName, partnerPhoto);

    // --- клік "переглянути профіль" (працює тільки якщо у Softr профіль по recordId)
    document.getElementById('profile-link').onclick = () => {
      window.location.href = `${SOFTR_PROFILE_URL}?recordId=${partnerId}`;
    };

    if (!myEmail || !partnerEmail) {
      // Без partnerEmail не зможемо коректно фільтрувати історію між 2 людьми
      disableChat(!partnerEmail
        ? `У users/${partnerId} додай поле email (пошта партнера).`
        : "Не задано твій email (me).");
      return;
    }

    // --- 3) Запуск чату + історії
    initChat(myEmail, partnerEmail);
  }

  function setAvatar(name, photoUrl) {
    const first = (name && name.length) ? name[0].toUpperCase() : "?";
    avatarChar.innerText = first;

    if (!photoUrl) {
      avatarChar.style.display = "flex";
      if (avatarPhoto) avatarPhoto.style.display = "none";
      return;
    }

    // пробуємо показати фото, якщо не вантажиться — fallback на літеру
    avatarPhoto.src = photoUrl;
    avatarPhoto.onload = () => {
      avatarPhoto.style.display = "block";
      avatarChar.style.display = "none";
    };
    avatarPhoto.onerror = () => {
      avatarPhoto.style.display = "none";
      avatarChar.style.display = "flex";
    };
  }

  function initChat(me, partner) {
    // беремо тільки повідомлення де є me, а потім фільтруємо по partner (як у тебе було)
    const q = query(
      collection(db, "messages"),
      where("participants", "array-contains", me),
      orderBy("createdAt", "asc"),
      limit(100)
    );

    onSnapshot(q, (snapshot) => {
      msgBox.innerHTML = '';
      snapshot.forEach((d) => {
        const data = d.data();
        if (Array.isArray(data.participants) && data.participants.includes(partner)) {
          renderMessage(data, me);
        }
      });
      setTimeout(() => msgBox.scrollTop = msgBox.scrollHeight, 80);
    });

    document.getElementById('send-btn').onclick = () => sendMessage(me, partner);
    document.getElementById('msg-input').onkeypress = (e) => {
      if (e.key === 'Enter') sendMessage(me, partner);
    };
  }

  function renderMessage(data, me) {
    const row = document.createElement('div');
    row.className = `msg-row ${data.sender === me ? 'mine' : 'theirs'}`;

    let content = '';
    if (data.imageUrl) content += `<img src="${data.imageUrl}" onclick="event.stopPropagation(); window.viewImage('${data.imageUrl}')">`;
    if (data.text) content += data.imageUrl ? `<div style="margin-top:6px">${escapeHtml(data.text)}</div>` : escapeHtml(data.text);

    const time = data.createdAt?.toDate
      ? new Date(data.createdAt.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      : '';

    row.innerHTML = `<div class="msg">${content}<span style="display:block; font-size:10px; opacity:0.7; text-align:right; margin-top:5px;">${time}</span></div>`;
    msgBox.appendChild(row);
  }

  async function sendMessage(me, partner) {
    const input = document.getElementById('msg-input');
    const text = (input.value || '').trim();
    if (!text) return;

    input.value = '';

    await addDoc(collection(db, "messages"), {
      text,
      sender: me,
      participants: [me, partner],
      createdAt: serverTimestamp()
    });
  }

  function disableChat(reason) {
    const input = document.getElementById('msg-input');
    const btn = document.getElementById('send-btn');
    if (input) { input.disabled = true; input.placeholder = reason; }
    if (btn) btn.style.opacity = "0.4";
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (m) => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
    }[m]));
  }

  // В'ювер картинки як у тебе було
  window.viewImage = (src) => {
    document.getElementById('viewer-img').src = src;
    document.getElementById('img-viewer').style.display = 'flex';
  };
</script>
