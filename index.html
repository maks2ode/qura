<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, limit } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBQNxVaRBgyiM0oJJjzDJ5MJi1WBVPlsdI",
    authDomain: "quradating777.firebaseapp.com",
    projectId: "quradating777",
    storageBucket: "quradating777.firebasestorage.app",
    messagingSenderId: "723638199684",
    appId: "1:723638199684:web:b00ea1895fd5b7ee63e9d1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // --- UI refs
  const chatTitle = document.getElementById('chat-title');
  const avatarChar = document.getElementById('avatar-char');
  const avatarPhoto = document.getElementById('avatar-photo'); // у тебе вже є <img id="avatar-photo"...>
  const msgBox = document.getElementById('messages');

  // --- URL params
  const params = new URLSearchParams(window.location.search);
  const partnerId = params.get('partnerId'); // ТІЛЬКИ ЦЕ приходить з Softr

  if (!partnerId) {
    chatTitle.innerText = "Немає partnerId";
    console.error("URL не має partnerId");
  }

  // --- helpers
  function makeChatId(a, b) {
    // стабільний chatId для двох людей, щоб історія була однакова
    return (a < b) ? `${a}__${b}` : `${b}__${a}`;
  }

  async function ensureLogin() {
    // Якщо не залогінений — відкриваємо Google login
    if (!auth.currentUser) {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    }
    return auth.currentUser;
  }

  function setHeader(partner) {
    // Ім'я
    chatTitle.innerText = partner?.name || `User ${partnerId}`;

    // Фото
    if (partner?.photo) {
      avatarPhoto.src = partner.photo;
      avatarPhoto.style.display = "block";
      avatarChar.style.display = "none";
    } else {
      // fallback на букву
      const first = (partner?.name || "U").trim().charAt(0).toUpperCase();
      avatarChar.innerText = first;
      avatarChar.style.display = "flex";
      avatarPhoto.style.display = "none";
    }
  }

  function renderMessage(data, myEmail) {
    const row = document.createElement('div');
    row.className = `msg-row ${data.sender === myEmail ? 'mine' : 'theirs'}`;

    let content = '';
    if (data.text) content += data.text;

    const time = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
    row.innerHTML = `<div class="msg">${content}<span style="display:block; font-size:10px; opacity:0.7; text-align:right; margin-top:5px;">${time}</span></div>`;
    msgBox.appendChild(row);
  }

  async function startChat() {
    // 1) Логін в Firebase (Google)
    const user = await ensureLogin();
    const myEmail = user.email;

    // 2) Підтягуємо партнера з /users/{partnerId}
    const partnerRef = doc(db, "users", String(partnerId));
    const partnerSnap = await getDoc(partnerRef);

    if (!partnerSnap.exists()) {
      chatTitle.innerText = `Немає users/${partnerId}`;
      console.error("Firestore: нема документа users/" + partnerId);
      return;
    }

    const partner = partnerSnap.data();
    if (!partner.email) {
      chatTitle.innerText = `users/${partnerId} без email`;
      console.error("Додай поле email у users/" + partnerId);
      return;
    }

    setHeader(partner);

    // 3) chatId (щоб історія зберігалась)
    const partnerEmail = partner.email;
    const chatId = makeChatId(myEmail, partnerEmail);

    // 4) слухаємо історію: chats/{chatId}/messages
    const messagesRef = collection(db, "chats", chatId, "messages");
    const q = query(messagesRef, orderBy("createdAt", "asc"), limit(200));

    onSnapshot(q, (snapshot) => {
      msgBox.innerHTML = "";
      snapshot.forEach((d) => renderMessage(d.data(), myEmail));
      setTimeout(() => msgBox.scrollTop = msgBox.scrollHeight, 50);
    });

    // 5) відправка
    async function sendMessage() {
      const input = document.getElementById('msg-input');
      const text = input.value.trim();
      if (!text) return;
      input.value = "";

      await addDoc(messagesRef, {
        text,
        sender: myEmail,
        createdAt: serverTimestamp()
      });
    }

    document.getElementById('send-btn').onclick = sendMessage;
    document.getElementById('msg-input').onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };
  }

  // Старт після перевірки auth
  onAuthStateChanged(auth, async () => {
    if (partnerId) await startChat();
  });
</script>
