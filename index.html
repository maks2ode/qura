<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc,
    collection, addDoc, query, orderBy, onSnapshot,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  import {
    getAuth, GoogleAuthProvider,
    signInWithRedirect, getRedirectResult,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // âœ… Ð¢Ð’ÐžÐ¯ firebaseConfig (ÐŸÐžÐ’ÐÐ†Ð¡Ð¢Ð®, Ð½Ðµ PASTE_HERE)
  const firebaseConfig = {
    apiKey: "AIzaSyBQNxVaRBgyiM0oJJjzDJ5MJi1WBVPlsdI",
    authDomain: "quradating777.firebaseapp.com",
    projectId: "quradating777",
    storageBucket: "quradating777.firebasestorage.app",
    messagingSenderId: "723638199684",
    appId: "1:723638199684:web:b00ea1895fd5b7ee63e9d1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const params = new URLSearchParams(window.location.search);
  const partnerId = params.get("partnerId"); // Ñ‚Ñ–Ð»ÑŒÐºÐ¸ Ñ†Ðµ Ð² URL

  const chatTitle = document.getElementById("chat-title");
  const avatarPhoto = document.getElementById("avatar-photo");
  const avatarChar = document.getElementById("avatar-char");
  const msgBox = document.getElementById("messages");
  const input = document.getElementById("msg-input");
  const sendBtn = document.getElementById("send-btn");

  function fail(msg) {
    console.error(msg);
    alert(msg);
  }

  function setHeader(name, photoUrl) {
    chatTitle.innerText = name || "...";

    if (photoUrl) {
      avatarPhoto.src = photoUrl;
      avatarPhoto.style.display = "block";
      avatarChar.style.display = "none";
    } else {
      avatarPhoto.style.display = "none";
      avatarChar.style.display = "flex";
      avatarChar.innerText = (name || "?").trim().charAt(0).toUpperCase();
    }
  }

  async function findMyUserDocIdByEmail(email) {
    // Ð£ ÑÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð¾Ð¼Ñƒ Ð²Ð°Ñ€Ñ–Ð°Ð½Ñ‚Ñ–: Ñ‚Ð¸ Ñ€ÑƒÐºÐ°Ð¼Ð¸ Ñ€Ð¾Ð±Ð¸Ñˆ users/{id}.email = email
    // Ð¢Ð¾Ð¼Ñƒ Ð¼Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿ÐµÑ€ÐµÐ±Ð¸Ñ€Ð°Ñ”Ð¼Ð¾ Ð²Ñ–Ð´Ð¾Ð¼Ñ– ID Ð½Ðµ Ð±ÑƒÐ´ÐµÐ¼Ð¾ â€” Ñ‡Ð¸Ñ‚Ð°Ñ”Ð¼Ð¾ Ð½Ð°Ð¿Ñ€ÑÐ¼Ñƒ:
    // ðŸ‘‰ Ñ€Ñ–ÑˆÐµÐ½Ð½Ñ: Ð·Ñ€Ð¾Ð±Ð¸ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ users/{email} Ð½Ðµ Ñ…Ð¾Ñ‡ÐµÑˆ. Ð¢Ð¾Ð¼Ñƒ:
    // Ð¢ÑƒÑ‚ Ð½Ð°Ð¹Ð¿Ñ€Ð¾ÑÑ‚Ñ–ÑˆÐµ: Ñ‚Ð¸ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ”Ñˆ myId Ñ‡ÐµÑ€ÐµÐ· URL/Embed, Ð°Ð»Ðµ Ð² Ñ‚ÐµÐ±Ðµ free.
    // Ð¢Ð¾Ð¼Ñƒ Ñ€Ð¾Ð±Ð¸Ð¼Ð¾ ÐºÐ¾Ð¼Ð¿Ñ€Ð¾Ð¼Ñ–Ñ: Ð·Ð±ÐµÑ€Ñ–Ð³Ð°Ñ”Ð¼Ð¾ "Ð¼Ñ–Ð¹" userId Ñƒ localStorage ÐŸÐ†Ð¡Ð›Ð¯ ÐŸÐ•Ð Ð¨ÐžÐ“Ðž ÑÐ¿Ñ–Ð²ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ñ.
    //
    // â— Ð Ñ‰Ð¾Ð± ÑÐ¿Ñ–Ð²ÑÑ‚Ð°Ð²Ð¸Ñ‚Ð¸ Ð·Ð°Ñ€Ð°Ð·: Ñ‡Ð¸Ñ‚Ð°Ñ”Ð¼Ð¾ users/1..N Ð¼Ð¸ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÐ¼Ð¾ Ð±ÐµÐ· ÑÐ¿Ð¸ÑÐºÑƒ.
    // Ð¢Ð¾Ð¼Ñƒ Ñ€Ð¾Ð±Ð¸Ð¼Ð¾ ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐž: Ð´Ð¾Ð´Ð°Ñ”Ð¼Ð¾ Ñ‰Ðµ Ð¾Ð´Ð½Ñƒ ÐºÐ¾Ð»ÐµÐºÑ†Ñ–ÑŽ "emails" (Ð¼Ð°Ð¿Ð° email -> userId)
    // Ð‡Ñ— Ñ‚Ð¸ ÑÑ‚Ð²Ð¾Ñ€ÑŽÑ”Ñˆ Ñ€ÑƒÐºÐ°Ð¼Ð¸ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ñƒ 1 Ñ€Ð°Ð·.
    const mapRef = doc(db, "emails", email.toLowerCase());
    const mapSnap = await getDoc(mapRef);
    if (!mapSnap.exists()) return null;
    return String(mapSnap.data().userId);
  }

  async function ensureEmailMap(email, myUserId) {
    // ÑÑ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾/Ð¾Ð½Ð¾Ð²Ð»ÑŽÑ”Ð¼Ð¾ emails/{email} -> {userId}
    const mapRef = doc(db, "emails", email.toLowerCase());
    await setDoc(mapRef, { userId: String(myUserId) }, { merge: true });
  }

  async function startChat(user) {
    if (!partnerId) return fail("ÐÐµÐ¼Ð° partnerId Ñƒ URL. ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¼Ð°Ñ” Ð²Ñ–Ð´ÐºÑ€Ð¸Ð²Ð°Ñ‚Ð¸ ?partnerId=4");

    const myEmail = (user?.email || "").toLowerCase();
    if (!myEmail) return fail("ÐÐµÐ¼Ð° email Ñƒ Firebase Auth. Ð£Ð²Ñ–Ð¹Ð´Ð¸ Ñ‡ÐµÑ€ÐµÐ· Google.");

    // 1) Ð·Ð½Ð°Ð¹Ñ‚Ð¸ Ð¼Ñ–Ð¹ userId Ñ‡ÐµÑ€ÐµÐ· emails/{email}
    const myUserId = await findMyUserDocIdByEmail(myEmail);
    if (!myUserId) {
      return fail("ÐÐµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð¼Ñ–Ð¹ Ð¿Ñ€Ð¾Ñ„Ñ–Ð»ÑŒ Ñƒ Firestore. Ð”Ð¾Ð´Ð°Ð¹ emails/{Ñ‚Ð²Ñ–Ð¹ email} -> userId.");
    }

    // 2) Ð²Ð¸Ñ‚ÑÐ³Ð½ÑƒÑ‚Ð¸ Ð¿Ð°Ñ€Ñ‚Ð½ÐµÑ€Ð°
    const partnerRef = doc(db, "users", String(partnerId));
    const partnerSnap = await getDoc(partnerRef);
    if (!partnerSnap.exists()) return fail("ÐÐµÐ¼Ð° ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð° users/" + partnerId);

    const partner = partnerSnap.data();
    const partnerEmail = (partner.email || "").toLowerCase();
    setHeader(partner.name || ("User " + partnerId), partner.photo || "");

    // 3) chatId ÑÑ‚Ð°Ð±Ñ–Ð»ÑŒÐ½Ð¸Ð¹ Ð¿Ð¾ userId (Ð° Ð½Ðµ Ð¿Ð¾ uid)
    const chatId = [String(myUserId), String(partnerId)].sort().join("_");

    // 4) ÑÑ‚Ð²Ð¾Ñ€Ð¸Ñ‚Ð¸ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ Ñ‡Ð°Ñ‚Ñƒ (ÑÐºÑ‰Ð¾ Ð½ÐµÐ¼Ð°) Ð· membersEmails
    const chatRef = doc(db, "chats", chatId);
    await setDoc(chatRef, {
      membersIds: [String(myUserId), String(partnerId)].sort(),
      membersEmails: [myEmail, partnerEmail].sort(),
      updatedAt: serverTimestamp()
    }, { merge: true });

    // 5) ÑÐ»ÑƒÑ…Ð°Ñ‚Ð¸ Ñ–ÑÑ‚Ð¾Ñ€Ñ–ÑŽ
    const msgsRef = collection(db, "chats", chatId, "messages");
    const q = query(msgsRef, orderBy("createdAt", "asc"));

    onSnapshot(q, (snapshot) => {
      msgBox.innerHTML = "";
      snapshot.forEach((d) => {
        const m = d.data();
        const row = document.createElement("div");
        row.className = "msg-row " + ((m.senderEmail || "").toLowerCase() === myEmail ? "mine" : "theirs");

        const time = m.createdAt ? new Date(m.createdAt.toDate()).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}) : "";
        row.innerHTML = `<div class="msg">${(m.text || "").replace(/</g,"&lt;")}
          <span style="display:block; font-size:10px; opacity:0.7; text-align:right; margin-top:5px;">${time}</span>
        </div>`;
        msgBox.appendChild(row);
      });
      setTimeout(() => msgBox.scrollTop = msgBox.scrollHeight, 0);
    });

    // 6) send
    sendBtn.onclick = async () => {
      const text = (input.value || "").trim();
      if (!text) return;
      input.value = "";

      await addDoc(msgsRef, {
        text,
        senderEmail: myEmail,
        createdAt: serverTimestamp()
      });

      await setDoc(chatRef, { updatedAt: serverTimestamp() }, { merge: true });
    };
  }

  // --- AUTH FLOW (redirect) ---
  try {
    await getRedirectResult(auth);
  } catch (e) {
    console.error(e);
  }

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      startChat(user);
    } else {
      // Ð¾Ð´Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÐ°/Ñ€Ð°Ð·: Ñ€ÐµÐ´Ñ–Ñ€ÐµÐºÑ‚-Ð»Ð¾Ð³Ñ–Ð½
      signInWithRedirect(auth, provider);
    }
  });

</script>
