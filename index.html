<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    collection,
    addDoc,
    query,
    orderBy,
    onSnapshot,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  import {
    getAuth,
    GoogleAuthProvider,
    signInWithRedirect,
    getRedirectResult,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // ✅ ТВОЯ Firebase config — встав СВОЇ реальні значення, не PASTE_HERE
  const firebaseConfig = {
    apiKey: "AIzaSyBQNxVaRBgyiM0oJJjzDJ5MJi1WBVPlsdI",
    authDomain: "quradating777.firebaseapp.com",
    projectId: "quradating777",
    storageBucket: "quradating777.firebasestorage.app",
    messagingSenderId: "723638199684",
    appId: "1:723638199684:web:b00ea1895fd5b7ee63e9d1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // --- URL params ---
  const params = new URLSearchParams(window.location.search);
  const partnerId = params.get("partnerId");

  // --- DOM (під твій HTML) ---
  const chatTitle = document.getElementById("chat-title");
  const avatarPhoto = document.getElementById("avatar-photo");
  const avatarChar = document.getElementById("avatar-char");
  const msgBox = document.getElementById("messages");
  const input = document.getElementById("msg-input");
  const sendBtn = document.getElementById("send-btn");

  function fail(msg) {
    console.error(msg);
    if (chatTitle) chatTitle.textContent = msg;
  }

  function normalizeEmail(email) {
    return String(email || "")
      .trim()
      .toLowerCase()
      .replaceAll(".", "_")
      .replaceAll("@", "__");
  }

  function makeChatId(aEmail, bEmail) {
    const a = normalizeEmail(aEmail);
    const b = normalizeEmail(bEmail);
    return [a, b].sort().join("___");
  }

  async function ensureSignedIn() {
    // 1) якщо вже повернулися з redirect — заберемо результат
    try { await getRedirectResult(auth); } catch (e) { /* ігноруємо */ }

    // 2) якщо не залогінений — робимо redirect login
    if (!auth.currentUser) {
      const provider = new GoogleAuthProvider();
      // щоб показував акаунт-селектор
      provider.setCustomParameters({ prompt: "select_account" });
      await signInWithRedirect(auth, provider);
      return null; // сторінка піде на redirect
    }
    return auth.currentUser;
  }

  async function loadPartner(partnerId) {
    if (!partnerId) throw new Error("Нема partnerId в URL");
    const ref = doc(db, "users", partnerId);
    const snap = await getDoc(ref);
    if (!snap.exists()) throw new Error(`Нема users/${partnerId} у Firestore`);
    return snap.data();
  }

  function setHeader(name, photoUrl) {
    const safeName = name || "...";
    chatTitle.textContent = safeName;

    // фото: якщо є — показуємо img, якщо нема — показуємо букву
    if (photoUrl) {
      avatarPhoto.src = photoUrl;
      avatarPhoto.style.display = "block";
      avatarChar.style.display = "none";
    } else {
      avatarChar.textContent = safeName.charAt(0).toUpperCase();
      avatarChar.style.display = "flex";
      avatarPhoto.style.display = "none";
    }
  }

  function renderMessage(m, myEmail) {
    const row = document.createElement("div");
    row.className = `msg-row ${m.senderEmail === myEmail ? "mine" : "theirs"}`;

    const bubble = document.createElement("div");
    bubble.className = "msg";
    bubble.textContent = m.text || "";
    row.appendChild(bubble);

    msgBox.appendChild(row);
  }

  async function startChat(myEmail, partner) {
    const partnerEmail = partner.email;
    if (!partnerEmail) throw new Error("У партнера нема поля email в users/{id}");

    setHeader(partner.name || partnerEmail, partner.photo || "");

    const chatId = makeChatId(myEmail, partnerEmail);

    // створимо “шапку” чату (корисно для правил/адмінки)
    const chatRef = doc(db, "chats", chatId);
    await setDoc(chatRef, {
      participants: [myEmail.toLowerCase(), partnerEmail.toLowerCase()].sort(),
      updatedAt: serverTimestamp()
    }, { merge: true });

    const msgsRef = collection(db, "chats", chatId, "messages");
    const q = query(msgsRef, orderBy("createdAt", "asc"));

    onSnapshot(q, (snapshot) => {
      msgBox.innerHTML = "";
      snapshot.forEach((d) => renderMessage(d.data(), myEmail));
      msgBox.scrollTop = msgBox.scrollHeight;
    });

    sendBtn.onclick = async () => {
      const text = input.value.trim();
      if (!text) return;

      await addDoc(msgsRef, {
        text,
        senderEmail: myEmail.toLowerCase(),
        createdAt: serverTimestamp()
      });

      input.value = "";
    };
  }

  // --- BOOT ---
  (async () => {
    try {
      if (!partnerId) return fail("❌ Нема partnerId в URL");

      // 1) авторизація (разово; без цього немає нормальної безпеки)
      await ensureSignedIn();

      // 2) чекаємо юзера
      onAuthStateChanged(auth, async (user) => {
        if (!user) return;

        const myEmail = user.email;
        if (!myEmail) return fail("❌ Firebase не дав email (перевір Google provider)");

        const partner = await loadPartner(partnerId);
        await startChat(myEmail, partner);
      });
    } catch (e) {
      fail("❌ " + (e?.message || e));
    }
  })();
</script>
