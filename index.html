<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
  <title>Qura Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-color: #000000;
      --header-bg: rgba(18, 18, 18, 0.98);
      --input-bg: #1a1a1a;
      --brand-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      --coin-color: #f59e0b;
      --text-primary: #ffffff;
      --text-secondary: #a1a1aa;
      --app-max-width: 600px;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; background: #050505; font-family: 'Plus Jakarta Sans', sans-serif;
      color: var(--text-primary); display: flex; flex-direction: column; height: 100dvh; overflow: hidden;
    }
    #app-container {
      width: 100%; height: 100%; display: flex; flex-direction: column; background: var(--bg-color);
      position: relative; margin: 0 auto;
    }
    @media (min-width: 768px) {
      #app-container { max-width: var(--app-max-width); border-left: 1px solid #222; border-right: 1px solid #222; }
    }

    /* HEADER */
    #header {
      padding: 10px 12px; background: var(--header-bg); border-bottom: 1px solid #222;
      display: flex; align-items: center; justify-content: space-between;
      z-index: 50; position: absolute; top: 0; left: 0; right: 0; backdrop-filter: blur(10px);
    }
    .header-left { display: flex; align-items: center; gap: 10px; cursor: pointer; flex: 1; overflow: hidden; }
    .back-btn { color: var(--text-secondary); display: flex; align-items: center; padding: 5px; }
    .avatar-circle {
      width: 34px; height: 34px; background: linear-gradient(45deg, #ff00cc, #333399);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 14px; flex-shrink: 0;
    }
    .user-info { display: flex; flex-direction: column; overflow: hidden; }
    .user-name { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-status { font-size: 11px; color: #6366f1; }

    .header-actions { display: flex; align-items: center; gap: 5px; }
    .header-btn {
      width: 34px; height: 34px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center;
      cursor: pointer; background: rgba(255,255,255,0.05); color: var(--text-secondary); transition: 0.2s;
    }
    .header-btn:active { transform: scale(0.9); }

    #profile-ai-btn { color: #8b5cf6; position: relative; }
    @keyframes pulse-purple {
      0% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4); }
      70% { box-shadow: 0 0 0 6px rgba(139, 92, 246, 0); }
      100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
    }
    .pulse-purple { animation: pulse-purple 2s infinite; }

    /* CHAT */
    #messages {
      flex: 1; overflow-y: auto; padding: 15px; padding-top: 70px; padding-bottom: 75px;
      display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth;
    }
    .msg-row { display: flex; width: 100%; }
    .msg { max-width: 85%; padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; }
    .mine { justify-content: flex-end; }
    .mine .msg { background: var(--brand-gradient); color: white; border-bottom-right-radius: 2px; }
    .theirs { justify-content: flex-start; }
    .theirs .msg { background: #27272a; color: white; border-bottom-left-radius: 2px; }
    .msg img { max-width: 100%; border-radius: 12px; margin-top: 5px; }

    /* INPUT */
    #input-area {
      padding: 8px 10px; padding-bottom: max(8px, env(safe-area-inset-bottom));
      background: var(--header-bg); border-top: 1px solid #222;
      display: flex; align-items: center; gap: 8px; position: absolute; bottom: 0; left: 0; right: 0; z-index: 50;
    }
    .input-wrapper {
      flex: 1; background: var(--input-bg); border-radius: 24px; padding: 8px 12px;
      display: flex; align-items: center; border: 1px solid #333; min-height: 40px; min-width: 0;
    }
    input[type="text"] { flex: 1; background: transparent; border: none; color: white; font-size: 16px; outline: none; min-width: 0; }
    .icon-btn {
      background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 6px;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    button#send-btn {
      background: var(--brand-gradient); width: 38px; height: 38px; border-radius: 50%; border: none;
      display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
    }

    #chat-ai-btn { color: #f59e0b; }
    @keyframes pulse-gold {
      0% { filter: drop-shadow(0 0 0px rgba(245, 158, 11, 0)); transform: scale(1); }
      50% { filter: drop-shadow(0 0 5px rgba(245, 158, 11, 0.6)); transform: scale(1.05); }
      100% { filter: drop-shadow(0 0 0px rgba(245, 158, 11, 0)); transform: scale(1); }
    }
    .pulse-gold { animation: pulse-gold 3s infinite ease-in-out; }

    /* PROMO MODALS */
    .overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200;
      backdrop-filter: blur(8px); align-items: center; justify-content: center; padding: 20px;
    }
    .promo-card {
      width: 100%; max-width: 380px; background: #121212; border-radius: 24px; border: 1px solid #333;
      padding: 30px 25px; display: flex; flex-direction: column; align-items: center; text-align: center;
      position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.6); animation: zoomIn 0.2s;
    }
    @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .promo-icon { font-size: 40px; margin-bottom: 15px; }
    .promo-title { font-size: 20px; font-weight: 800; color: white; margin-bottom: 10px; }
    .promo-text { color: #aaa; font-size: 14px; line-height: 1.5; margin-bottom: 25px; }

    .promo-bullets { text-align: left; width: 100%; margin-bottom: 25px; background: #1a1a1a; padding: 15px; border-radius: 12px; }
    .bullet { display: flex; gap: 10px; font-size: 13px; color: #ccc; margin-bottom: 8px; }
    .bullet:last-child { margin-bottom: 0; }

    .action-button {
      width: 100%; padding: 16px; border-radius: 14px; border: none; font-weight: 700; font-size: 15px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: transform 0.1s;
    }
    .action-button:active { transform: scale(0.95); }
    .btn-gold { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: black; }
    .btn-purple { background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; }
    .close-promo { position: absolute; top: 15px; right: 15px; background: none; border: none; color: #555; font-size: 24px; cursor: pointer; }

    /* OTHER */
    #ai-result-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 300; display: none; align-items: center; justify-content: center; padding: 20px; }
    .ai-res-card { background: #151515; width: 100%; max-width: 500px; border-radius: 20px; padding: 25px; border: 1px solid #333; max-height: 80vh; overflow-y: auto; color: #eee; }
    #loader { display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #111; padding: 20px; border-radius: 15px; z-index: 500; text-align: center; border: 1px solid #333; width: 170px; }
    .spinner { width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.2); border-radius: 50%; border-top-color: #f59e0b; animation: spin 1s infinite linear; margin: 0 auto 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #img-viewer { display: none; position: fixed; inset: 0; background: black; z-index: 600; align-items: center; justify-content: center; }
    #img-viewer img { max-width: 100%; max-height: 100%; }
    #close-viewer { position: absolute; top: 20px; right: 20px; color: white; background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; }

    /* login overlay */
    #login-overlay {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.88); z-index: 1000; padding: 20px;
    }
    .login-card {
      width: 100%; max-width: 420px; background: #121212; border-radius: 24px; border: 1px solid #333;
      padding: 26px; text-align: center;
    }
    .login-title { font-size: 18px; font-weight: 800; margin-bottom: 8px; }
    .login-sub { font-size: 13px; color: #aaa; margin-bottom: 16px; line-height: 1.4; }
    .login-btn {
      width: 100%; border: none; border-radius: 14px; padding: 14px 16px; cursor: pointer;
      font-weight: 800; background: var(--brand-gradient); color: #fff;
    }
    .small-note { margin-top: 10px; font-size: 11px; color: #666; }
  </style>
</head>
<body>

<div id="app-container">
  <div id="header">
    <div class="header-left" id="profile-link" title="–ü—Ä–æ—Ñ—ñ–ª—å">
      <div class="back-btn" id="back-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
      </div>
      <div class="avatar-circle" id="avatar-char">?</div>
      <div class="user-info">
        <div class="user-name" id="chat-title">...</div>
        <div class="user-status" id="chat-subtitle">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</div>
      </div>
    </div>

    <div class="header-actions">
      <button class="header-btn pulse-purple" id="profile-ai-btn" onclick="openPromo('profile')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
          <path d="M12 2v2"/><path d="M12 20v2"/><path d="M20 12h2"/><path d="M2 12h2"/>
        </svg>
      </button>
      <button class="header-btn" onclick="openReportMenu()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
      </button>
    </div>
  </div>

  <div id="messages"></div>

  <div id="input-area">
    <button class="icon-btn" id="attach-btn" title="–§–æ—Ç–æ">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
      </svg>
    </button>

    <button class="icon-btn pulse-gold" id="chat-ai-btn" onclick="openPromo('chat')" title="AI">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
      </svg>
    </button>

    <input type="file" id="file-input" accept="image/*" style="display: none;">
    <div class="input-wrapper">
      <input type="text" id="msg-input" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." autocomplete="off" />
    </div>
    <button id="send-btn" title="–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="4" width="20" height="16" rx="2" />
        <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" />
      </svg>
    </button>
  </div>
</div>

<!-- LOGIN -->
<div id="login-overlay">
  <div class="login-card">
    <div class="login-title">–£–≤—ñ–π–¥–∏ —á–µ—Ä–µ–∑ Google</div>
    <div class="login-sub">
      –ß–∞—Ç –ø—Ä–∞—Ü—é—î –∑ URL –≤–∏–¥—É <b>/t/123</b> —ñ –∑–±–µ—Ä—ñ–≥–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ <b>threads/{id}/messages</b> (–∞–±–æ <b>massages</b> —è–∫—â–æ —Ç–∞–∫ —É –±–∞–∑—ñ).
    </div>
    <button class="login-btn" id="google-login-btn">Google Login</button>
    <div class="small-note" id="login-note"></div>
  </div>
</div>

<!-- PROMOS -->
<div id="promo-profile" class="overlay">
  <div class="promo-card">
    <button class="close-promo" onclick="closeOverlays()">&times;</button>
    <div class="promo-icon">üß†</div>
    <div class="promo-title">–ü—Å–∏—Ö–æ–ª–æ–≥—ñ—á–Ω–∏–π –ü–æ—Ä—Ç—Ä–µ—Ç</div>
    <div class="promo-text">–®–Ü –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É—î –ø—Ä–æ—Ñ—ñ–ª—å —Ç–∞ —Ñ–æ—Ç–æ, —â–æ–± —Ä–æ–∑–∫—Ä–∏—Ç–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä –ª—é–¥–∏–Ω–∏.</div>
    <div class="promo-bullets">
      <div class="bullet">‚úÖ –ü—Ä–∏—Ö–æ–≤–∞–Ω—ñ —Ä–∏—Å–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä—É</div>
      <div class="bullet">‚úÖ –¢–µ–º–∏, —è–∫—ñ —ó—ó —Ç–æ—á–Ω–æ –∑–∞—á–µ–ø–ª—è—Ç—å</div>
      <div class="bullet">üö© "–ß–µ—Ä–≤–æ–Ω—ñ –ø—Ä–∞–ø–æ—Ä—Ü—ñ"</div>
    </div>
    <button class="action-button btn-purple" onclick="useService('profile', 2)">–ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∑–∞ 2 Qura Coins</button>
  </div>
</div>

<div id="promo-chat" class="overlay">
  <div class="promo-card">
    <button class="close-promo" onclick="closeOverlays()">&times;</button>
    <div class="promo-icon">‚ú®</div>
    <div class="promo-title">–Ü–¥–µ–∞–ª—å–Ω–∞ –í—ñ–¥–ø–æ–≤—ñ–¥—å</div>
    <div class="promo-text">Qura AI –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É—î –¥—ñ–∞–ª–æ–≥ —ñ –ø—ñ–¥–∫–∞–∂–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å.</div>
    <div class="promo-bullets">
      <div class="bullet">üöÄ –ü—ñ–¥–≤–∏—â—É—î —à–∞–Ω—Å –Ω–∞ –ø–æ–±–∞—á–µ–Ω–Ω—è</div>
      <div class="bullet">üí° –†–æ–∑—É–º—ñ—î –ø—ñ–¥—Ç–µ–∫—Å—Ç</div>
      <div class="bullet">‚úçÔ∏è –ü–∏—à–µ –∑–∞ —Ç–µ–±–µ</div>
    </div>
    <button class="action-button btn-gold" onclick="useService('chat', 1)">–û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Ä–∞–¥—É –∑–∞ 1 Qura Coin</button>
  </div>
</div>

<div id="report-overlay" class="overlay">
  <div class="promo-card">
    <button class="close-promo" onclick="closeOverlays()">&times;</button>
    <div class="promo-title">–ü–æ—Å–∫–∞—Ä–∂–∏—Ç–∏—Å—è</div>
    <div class="promo-bullets">
      <div class="bullet" onclick="submitReport('spam')">üö© –°–ø–∞–º / –†–µ–∫–ª–∞–º–∞</div>
      <div class="bullet" onclick="submitReport('fake')">üé≠ –§–µ–π–∫–æ–≤–∏–π –ø—Ä–æ—Ñ—ñ–ª—å</div>
      <div class="bullet" onclick="submitReport('insult')">ü§¨ –û–±—Ä–∞–∑–∏ / –ì—Ä—É–±—ñ—Å—Ç—å</div>
    </div>
    <button class="action-button" style="background:#333;color:#fff" onclick="closeOverlays()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
  </div>
</div>

<div id="ai-result-modal">
  <div class="ai-res-card">
    <button id="close-ai" onclick="document.getElementById('ai-result-modal').style.display='none'">&times;</button>
    <div style="font-size:18px; font-weight:bold; color:#fbbf24; margin-bottom:15px;">‚ú® –†–µ–∑—É–ª—å—Ç–∞—Ç</div>
    <div id="ai-text" style="line-height:1.6; font-size:14px; color:#e5e5e5;"></div>
  </div>
</div>

<div id="loader">
  <div class="spinner"></div>
  <div id="loader-txt">–û–±—Ä–æ–±–∫–∞...</div>
</div>

<div id="img-viewer" onclick="this.style.display='none'">
  <div id="close-viewer">&times;</div>
  <img id="viewer-img" src="">
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, doc, getDoc, collection, addDoc, query, orderBy, onSnapshot, limit, serverTimestamp, getDocs
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  import {
    getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // === CONFIG (—Ç–≤—ñ–π –ø—Ä–æ–µ–∫—Ç) ===
  const firebaseConfig = {
    apiKey: "AIzaSyBQNxVaRBgyiM0oJJjzDJ5MJi1WBVPlsdI",
    authDomain: "quradating777.firebaseapp.com",
    projectId: "quradating777",
    storageBucket: "quradating777.firebasestorage.app",
    messagingSenderId: "723638199684",
    appId: "1:723638199684:web:b00ea1895fd5b7ee63e9d1"
  };

  // === LINKS (–ø—Ä–æ—Ñ—ñ–ª—å) ===
  const SOFTR_PROFILE_URL = "https://quradating.softr.app/user-profile";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // UI refs
  const chatTitle = document.getElementById('chat-title');
  const chatSubtitle = document.getElementById('chat-subtitle');
  const avatarChar = document.getElementById('avatar-char');
  const msgBox = document.getElementById('messages');
  const loginOverlay = document.getElementById('login-overlay');
  const loginNote = document.getElementById('login-note');

  // state
  let myEmail = null;
  let threadId = null;
  let partnerEmail = null;
  let partnerUserId = null;
  let msgsSubcollectionName = "messages"; // default

  // ===== ROUTING: /t/123 =====
  function extractThreadIdFromPath() {
    const p = (window.location.pathname || "").replace(/\/+$/, ""); // trim trailing /
    const m = p.match(/^\/t\/([^/]+)$/);
    if (m && m[1]) return decodeURIComponent(m[1]);
    return null;
  }

  function showLoader(txt) {
    document.getElementById('loader').style.display = 'block';
    document.getElementById('loader-txt').innerText = txt || "–û–±—Ä–æ–±–∫–∞...";
  }
  function hideLoader() {
    document.getElementById('loader').style.display = 'none';
  }

  // ===== UI helpers =====
  window.openPromo = (type) => {
    document.getElementById(type === 'profile' ? 'promo-profile' : 'promo-chat').style.display = 'flex';
  };
  window.closeOverlays = () => {
    document.querySelectorAll('.overlay').forEach(el => el.style.display = 'none');
  };
  window.openReportMenu = () => document.getElementById('report-overlay').style.display = 'flex';
  window.submitReport = () => { closeOverlays(); alert("–°–∫–∞—Ä–≥—É –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ."); };
  window.useService = (type) => {
    closeOverlays();
    document.getElementById('ai-result-modal').style.display = 'flex';
    const text = document.getElementById('ai-text');
    text.innerHTML = (type === 'chat')
      ? "<b>AI:</b><br><br>–ü–æ—Ä–∞–¥–∞: –∑–∞–¥–∞–π –ø—Ä–æ—Å—Ç–µ –ø–∏—Ç–∞–Ω–Ω—è —ñ –¥–æ–¥–∞–π –≥—É–º–æ—Ä üôÇ"
      : "<b>AI:</b><br><br>–ü–æ—Ä–∞–¥–∞: –∑–≥–∞–¥–∞–π 1 –¥–µ—Ç–∞–ª—å –∑ –ø—Ä–æ—Ñ—ñ–ª—é —ñ –ø–æ—á–Ω–∏ –∑ –Ω–µ—ó.";
  };
  window.viewImage = (src) => {
    document.getElementById('viewer-img').src = src;
    document.getElementById('img-viewer').style.display = 'flex';
  };

  // back button (–ø—Ä–æ—Å—Ç–∏–π)
  document.getElementById('back-btn').onclick = () => history.back();

  // ===== AUTH =====
  document.getElementById('google-login-btn').onclick = async () => {
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    } catch (e) {
      loginNote.innerText = "–ü–æ–º–∏–ª–∫–∞ –ª–æ–≥—ñ–Ω—É: " + (e?.message || e);
    }
  };

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      loginOverlay.style.display = 'flex';
      return;
    }

    loginOverlay.style.display = 'none';
    myEmail = user.email;

    // thread id
    threadId = extractThreadIdFromPath();
    if (!threadId) {
      // fallback: ?t=123
      const params = new URLSearchParams(window.location.search);
      threadId = params.get("t");
    }

    if (!threadId) {
      chatTitle.innerText = "–ù–µ–º–∞ threadId";
      chatSubtitle.innerText = "–í—ñ–¥–∫—Ä–∏–π /t/123";
      return;
    }

    await initThreadAndChat();
  });

  // ===== Firestore helpers =====

  async function loadThreadParticipants() {
    // threads/{threadId}
    const tRef = doc(db, "threads", threadId);
    const snap = await getDoc(tRef);
    if (!snap.exists()) return null;
    const data = snap.data();
    return data?.participants || null;
  }

  async function resolvePartnerEmail(participants) {
    if (!Array.isArray(participants)) return null;
    const other = participants.find(x => x && x !== myEmail);
    return other || null;
  }

  async function resolveUserIdByEmail(email) {
    // emails/{email} -> { userId: "2" }
    if (!email) return null;
    const eRef = doc(db, "emails", email);
    const snap = await getDoc(eRef);
    if (!snap.exists()) return null;
    const data = snap.data();
    return data?.userId || null;
  }

  async function chooseMessagesSubcollection() {
    // –∞–≤—Ç–æ–¥–µ—Ç–µ–∫—Ç: —Å–ø–æ—á–∞—Ç–∫—É messages, —è–∫—â–æ –ø—É—Å—Ç–æ/–Ω–µ–º–∞ ‚Äî –ø—Ä–æ–±—É—î–º–æ massages
    const tryNames = ["messages", "massages"];
    for (const name of tryNames) {
      try {
        const ref = collection(db, "threads", threadId, name);
        const q = query(ref, orderBy("createdAt", "desc"), limit(1));
        const s = await getDocs(q);
        if (!s.empty) return name; // —î —Ö–æ—á 1 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
      } catch (e) {
        // —è–∫—â–æ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É/—ñ–Ω–¥–µ–∫—Å–∞ ‚Äî —ñ–¥–µ–º–æ –¥–∞–ª—ñ
      }
    }
    // —è–∫—â–æ –æ–±–∏–¥–≤—ñ –ø—É—Å—Ç—ñ ‚Äî –±–µ—Ä–µ–º–æ "messages" —è–∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç
    return "messages";
  }

  function renderHeader() {
    const title = partnerEmail
      ? partnerEmail.split('@')[0]
      : ("Thread " + threadId);

    chatTitle.innerText = title.charAt(0).toUpperCase() + title.slice(1);
    avatarChar.innerText = title.charAt(0).toUpperCase();

    chatSubtitle.innerText = partnerUserId ? "–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å" : "–ü—Ä–æ—Ñ—ñ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π";
  }

  function attachProfileClick() {
    document.getElementById('profile-link').onclick = () => {
      if (!partnerUserId) return;
      window.location.href = `${SOFTR_PROFILE_URL}?recordId=${encodeURIComponent(partnerUserId)}`;
    };
  }

  function renderMessage(data) {
    const row = document.createElement('div');
    row.className = `msg-row ${data.sender === myEmail ? 'mine' : 'theirs'}`;

    let content = '';
    if (data.imageUrl) {
      content += `<img src="${data.imageUrl}" onclick="event.stopPropagation(); window.viewImage('${data.imageUrl}')">`;
    }
    if (data.text) {
      content += data.imageUrl ? `<div style="margin-top:6px">${escapeHtml(data.text)}</div>` : escapeHtml(data.text);
    }

    const time = data.createdAt?.toDate
      ? new Date(data.createdAt.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
      : '';

    row.innerHTML = `
      <div class="msg">
        ${content}
        <span style="display:block; font-size:10px; opacity:0.7; text-align:right; margin-top:5px;">${time}</span>
      </div>
    `;
    msgBox.appendChild(row);
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[s]));
  }

  async function initThreadAndChat() {
    try {
      showLoader("–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...");

      // participants –∑ threads/{id}
      const participants = await loadThreadParticipants();
      partnerEmail = await resolvePartnerEmail(participants);

      // userId –ø–∞—Ä—Ç–Ω–µ—Ä–∞ —á–µ—Ä–µ–∑ emails/{email}
      partnerUserId = await resolveUserIdByEmail(partnerEmail);

      // –≤–∏–±—ñ—Ä messages vs massages
      msgsSubcollectionName = await chooseMessagesSubcollection();

      renderHeader();
      attachProfileClick();

      // realtime messages
      const msgsRef = collection(db, "threads", threadId, msgsSubcollectionName);
      const q = query(msgsRef, orderBy("createdAt", "asc"), limit(80));

      onSnapshot(q, (snapshot) => {
        msgBox.innerHTML = '';
        snapshot.forEach((d) => renderMessage(d.data()));
        setTimeout(() => { msgBox.scrollTop = msgBox.scrollHeight; }, 50);
      });

      // input handlers
      document.getElementById('send-btn').onclick = sendMessage;
      document.getElementById('msg-input').onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };
      document.getElementById('attach-btn').onclick = () => document.getElementById('file-input').click();
      document.getElementById('file-input').onchange = handleFileUpload;

    } catch (e) {
      alert("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó: " + (e?.message || e));
    } finally {
      hideLoader();
    }
  }

  async function sendMessage() {
    const input = document.getElementById('msg-input');
    const text = input.value.trim();
    if (!text) return;

    input.value = '';

    try {
      const ref = collection(db, "threads", threadId, msgsSubcollectionName);
      await addDoc(ref, {
        text,
        sender: myEmail,
        participants: partnerEmail ? [myEmail, partnerEmail] : [myEmail],
        createdAt: serverTimestamp()
      });
    } catch (e) {
      alert("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏: " + (e?.message || e));
    }
  }

  function handleFileUpload(e) {
    const file = e.target.files?.[0];
    if (!file) return;

    showLoader("–°—Ç–∏—Å–∫–∞—î–º–æ...");
    const reader = new FileReader();
    reader.readAsDataURL(file);

    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target.result;

      img.onload = async () => {
        try {
          const canvas = document.createElement('canvas');
          const MAX_WIDTH = 600;
          let width = img.width;
          let height = img.height;

          if (width > MAX_WIDTH) {
            height *= MAX_WIDTH / width;
            width = MAX_WIDTH;
          }

          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          const dataUrl = canvas.toDataURL('image/jpeg', 0.5);

          const ref = collection(db, "threads", threadId, msgsSubcollectionName);
          await addDoc(ref, {
            text: "",
            imageUrl: dataUrl,
            sender: myEmail,
            participants: partnerEmail ? [myEmail, partnerEmail] : [myEmail],
            createdAt: serverTimestamp()
          });

        } catch (err) {
          alert("–ü–æ–º–∏–ª–∫–∞ —Ñ–æ—Ç–æ: " + (err?.message || err));
        } finally {
          e.target.value = '';
          hideLoader();
        }
      };
    };

    reader.onerror = () => {
      hideLoader();
      alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ñ–∞–π–ª");
    };
  }
</script>

</body>
</html>
