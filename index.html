<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    doc,
    getDoc,
    collection,
    addDoc,
    query,
    orderBy,
    onSnapshot,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  import {
    getAuth,
    signInAnonymously,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // ðŸ”¥ Ð¢Ð’ÐžÐ¯ CONFIG (Ð·Ð°Ð»Ð¸Ñˆ ÑÐº Ñ”)
  const firebaseConfig = {
    apiKey: "PASTE_HERE",
    authDomain: "PASTE_HERE",
    projectId: "PASTE_HERE",
    storageBucket: "PASTE_HERE",
    messagingSenderId: "PASTE_HERE",
    appId: "PASTE_HERE"
  };

  // Init
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // URL partnerId
  const params = new URLSearchParams(window.location.search);
  const partnerId = params.get("partnerId");

  // Elements
  const headerName = document.getElementById("chat-name");
  const headerPhoto = document.getElementById("chat-photo");
  const messagesBox = document.getElementById("messages");
  const input = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");

  // ðŸ”‘ ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ñ–Ñ (Ñ‚Ð¸Ñ…Ð¾)
  signInAnonymously(auth);

  onAuthStateChanged(auth, async (user) => {
    if (!user) return;

    const myId = user.uid;

    // ðŸ”¥ ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚Ð¸ partner info
    const userRef = doc(db, "users", partnerId);
    const snap = await getDoc(userRef);

    if (snap.exists()) {
      const data = snap.data();
      headerName.textContent = data.name || partnerId;
      headerPhoto.src = data.photo || "";
    }

    // ðŸ“Œ Chat ID (ÑƒÐ½Ñ–ÐºÐ°Ð»ÑŒÐ½Ð¾ Ð´Ð»Ñ Ð´Ð²Ð¾Ñ… Ð»ÑŽÐ´ÐµÐ¹)
    const chatId = [myId, partnerId].sort().join("_");

    // ðŸ“© Ð¡Ð»ÑƒÑ…Ð°Ñ”Ð¼Ð¾ Ñ–ÑÑ‚Ð¾Ñ€Ñ–ÑŽ
    const msgsRef = collection(db, "chats", chatId, "messages");

    const q = query(msgsRef, orderBy("createdAt"));

    onSnapshot(q, (snapshot) => {
      messagesBox.innerHTML = "";

      snapshot.forEach((doc) => {
        const msg = doc.data();

        const div = document.createElement("div");
        div.textContent = msg.text;
        div.style.padding = "8px";
        div.style.margin = "6px";
        div.style.borderRadius = "10px";

        div.style.background =
          msg.sender === myId ? "#4f46e5" : "#222";

        messagesBox.appendChild(div);
      });

      messagesBox.scrollTop = messagesBox.scrollHeight;
    });

    // âœ‰ï¸ ÐÐ°Ð´ÑÐ¸Ð»Ð°Ð½Ð½Ñ
    sendBtn.onclick = async () => {
      const text = input.value.trim();
      if (!text) return;

      await addDoc(msgsRef, {
        text: text,
        sender: myId,
        createdAt: serverTimestamp()
      });

      input.value = "";
    };
  });
</script>
