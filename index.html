<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
  <title>Qura Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #000000;
      --header-bg: rgba(18, 18, 18, 0.98);
      --input-bg: #1a1a1a;
      --brand-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      --text-primary: #ffffff;
      --text-secondary: #a1a1aa;
      --app-max-width: 600px;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; background: #050505; font-family: 'Plus Jakarta Sans', sans-serif;
      color: var(--text-primary); display: flex; flex-direction: column; height: 100dvh; overflow: hidden;
    }
    #app-container {
      width: 100%; height: 100%; display: flex; flex-direction: column; background: var(--bg-color);
      position: relative; margin: 0 auto;
    }
    @media (min-width: 768px) {
      #app-container { max-width: var(--app-max-width); border-left: 1px solid #222; border-right: 1px solid #222; }
    }

    /* HEADER */
    #header {
      padding: 10px 12px; background: var(--header-bg); border-bottom: 1px solid #222;
      display: flex; align-items: center; justify-content: space-between;
      z-index: 50; position: absolute; top: 0; left: 0; right: 0; backdrop-filter: blur(10px);
    }
    .header-left { display: flex; align-items: center; gap: 10px; cursor: pointer; flex: 1; overflow: hidden; }
    .back-btn { color: var(--text-secondary); display: flex; align-items: center; padding: 5px; }
    .avatar-circle {
      width: 34px; height: 34px; background: linear-gradient(45deg, #ff00cc, #333399);
      border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; flex-shrink: 0;
    }
    .user-info { display: flex; flex-direction: column; overflow: hidden; }
    .user-name { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-status { font-size: 11px; color: #6366f1; }

    .header-actions { display: flex; align-items: center; gap: 5px; }
    .header-btn {
      width: 34px; height: 34px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer;
      background: rgba(255,255,255,0.05); color: var(--text-secondary); transition: 0.2s;
    }
    .header-btn:active { transform: scale(0.9); }

    /* CHAT */
    #messages {
      flex: 1; overflow-y: auto; padding: 15px; padding-top: 70px; padding-bottom: 75px;
      display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth;
    }
    .msg-row { display: flex; width: 100%; }
    .msg { max-width: 85%; padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; }
    .mine { justify-content: flex-end; }
    .mine .msg { background: var(--brand-gradient); color: white; border-bottom-right-radius: 2px; }
    .theirs { justify-content: flex-start; }
    .theirs .msg { background: #27272a; color: white; border-bottom-left-radius: 2px; }
    .msg img { max-width: 100%; border-radius: 12px; margin-top: 5px; }

    /* INPUT */
    #input-area {
      padding: 8px 10px; padding-bottom: max(8px, env(safe-area-inset-bottom));
      background: var(--header-bg); border-top: 1px solid #222;
      display: flex; align-items: center; gap: 8px; position: absolute; bottom: 0; left: 0; right: 0; z-index: 50;
    }
    .input-wrapper {
      flex: 1; background: var(--input-bg); border-radius: 24px; padding: 8px 12px;
      display: flex; align-items: center; border: 1px solid #333; min-height: 40px; min-width: 0;
    }
    input[type="text"] { flex: 1; background: transparent; border: none; color: white; font-size: 16px; outline: none; min-width: 0; }
    .icon-btn {
      background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 6px;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    button#send-btn {
      background: var(--brand-gradient); width: 38px; height: 38px; border-radius: 50%; border: none;
      display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
    }

    /* LOGIN SCREEN */
    #login-screen{
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.85); z-index: 999;
    }
    #login-card{
      width: 92%; max-width: 380px; background: #121212; border: 1px solid #333; border-radius: 20px;
      padding: 22px;
    }
    #login-card h2{ margin: 0 0 10px 0; font-size: 18px; }
    #login-card p{ margin: 0 0 16px 0; color: #aaa; font-size: 13px; }
    #google-btn{
      width: 100%; padding: 14px; border-radius: 14px; border: none; font-weight: 800;
      background: var(--brand-gradient); color: #fff; cursor: pointer;
    }
    #statusline{
      position: absolute; top: 56px; left: 12px;
      color: #8b5cf6; font-size: 12px; opacity: 0.95;
    }
  </style>
</head>
<body>

<div id="app-container">
  <div id="header">
    <div class="header-left" id="profile-link">
      <div class="back-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </div>
      <div class="avatar-circle" id="avatar-char">?</div>
      <div class="user-info">
        <div class="user-name" id="chat-title">Qura Chat</div>
        <div class="user-status" id="chat-subtitle">Завантажую…</div>
      </div>
    </div>

    <div class="header-actions">
      <button class="header-btn" id="logout-btn" title="Logout">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
          <path d="M16 17l5-5-5-5"/>
          <path d="M21 12H9"/>
        </svg>
      </button>
    </div>
  </div>

  <div id="statusline"></div>
  <div id="messages"></div>

  <div id="input-area">
    <button class="icon-btn" id="attach-btn" title="Attach">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
      </svg>
    </button>
    <input type="file" id="file-input" accept="image/*" style="display:none;">
    <div class="input-wrapper">
      <input type="text" id="msg-input" placeholder="Повідомлення..." autocomplete="off" />
    </div>
    <button id="send-btn" title="Send">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="4" width="20" height="16" rx="2" />
        <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" />
      </svg>
    </button>
  </div>
</div>

<div id="login-screen">
  <div id="login-card">
    <h2>Увійди, щоб продовжити</h2>
    <p>Google login потрібен, бо доступ до thread перевіряється по email.</p>
    <button id="google-btn">Sign in with Google</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, doc, getDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import {
    getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult,
    onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // === CONFIG ===
  const firebaseConfig = {
    apiKey: "PUT_YOUR_API_KEY_HERE",
    authDomain: "quradating777.firebaseapp.com",
    projectId: "quradating777",
    storageBucket: "quradating777.firebasestorage.app",
    messagingSenderId: "723638199684",
    appId: "1:723638199684:web:b00ea1895fd5b7ee63e9d1"
  };

  // профіль (якщо в thread буде partnerUserId)
  const SOFTR_PROFILE_URL = "https://quradating.softr.app/user-profile";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // === UI ===
  const loginScreen = document.getElementById('login-screen');
  const googleBtn = document.getElementById('google-btn');
  const logoutBtn = document.getElementById('logout-btn');
  const msgBox = document.getElementById('messages');
  const input = document.getElementById('msg-input');
  const sendBtn = document.getElementById('send-btn');
  const attachBtn = document.getElementById('attach-btn');
  const fileInput = document.getElementById('file-input');
  const chatTitle = document.getElementById('chat-title');
  const chatSubtitle = document.getElementById('chat-subtitle');
  const avatarChar = document.getElementById('avatar-char');
  const statusline = document.getElementById('statusline');
  const profileLink = document.getElementById('profile-link');

  function setStatus(t){ statusline.textContent = t || ""; }

  // === THREAD ID from /t/123 ===
  function getThreadIdFromPath(){
    const parts = window.location.pathname.split('/').filter(Boolean);
    const tIndex = parts.indexOf('t');
    if (tIndex === -1) return null;
    return parts[tIndex + 1] || null;
  }
  const threadId = getThreadIdFromPath();

  if(!threadId){
    chatSubtitle.textContent = "Нема THREAD_ID. Відкрий /t/THREAD_ID";
    setStatus("");
  }

  // === AUTH FLOW ===
  googleBtn.onclick = () => signInWithRedirect(auth, provider);
  logoutBtn.onclick = () => signOut(auth);

  // якщо повернуло з redirect — ок
  getRedirectResult(auth).catch(()=>{});

  let unsub = null;
  let meEmail = null;
  let partnerEmail = null;
  let partnerUserId = null;

  onAuthStateChanged(auth, async (user) => {
    if(!threadId) return;

    if(!user){
      loginScreen.style.display = "flex";
      chatSubtitle.textContent = "Потрібен Google login";
      setStatus("");
      return;
    }

    loginScreen.style.display = "none";
    meEmail = user.email;

    // 1) читаємо threads/{threadId}
    setStatus("Перевіряю доступ…");
    const threadRef = doc(db, "threads", threadId);
    const threadSnap = await getDoc(threadRef);

    if(!threadSnap.exists()){
      chatSubtitle.textContent = "Thread не існує";
      setStatus("");
      return;
    }

    const thread = threadSnap.data();
    const participants = Array.isArray(thread.participants) ? thread.participants : [];

    // 2) доступ: email має бути в participants
    if(!participants.includes(meEmail)){
      chatSubtitle.textContent = "ACCESS: NO";
      setStatus("Нема доступу до цього thread");
      return;
    }

    // 3) визначаємо партнера
    partnerEmail = participants.find(e => e !== meEmail) || meEmail;

    // partnerUserId (якщо ти зберігаєш у threads/{id}.participantsUserIds або partnerUserId)
    // ПІДТРИМКА 2 варіантів:
    // A) thread.partnerUserId
    // B) thread.participantsUserIds = { "email@": "UserID" }
    partnerUserId = thread.partnerUserId || (thread.participantsUserIds && thread.participantsUserIds[partnerEmail]) || null;

    const name = (partnerEmail || "Chat").split('@')[0];
    chatTitle.textContent = name.charAt(0).toUpperCase() + name.slice(1);
    avatarChar.textContent = name.charAt(0).toUpperCase();
    chatSubtitle.textContent = "ACCESS: OK";
    setStatus("");

    // 4) слухаємо threads/{id}/messages
    if(unsub) unsub();
    const msgsRef = collection(db, "threads", threadId, "messages");
    const q = query(msgsRef, orderBy("createdAt", "asc"));

    setStatus("Завантажую повідомлення…");
    unsub = onSnapshot(q, (snap) => {
      msgBox.innerHTML = "";
      snap.forEach(d => renderMessage(d.data()));
      msgBox.scrollTop = msgBox.scrollHeight;
      setStatus("");
    }, (err) => {
      setStatus("Помилка читання: " + err.message);
    });
  });

  // === PROFILE BUTTON ===
  profileLink.onclick = () => {
    if(!partnerUserId){
      alert("Нема partner UserID у thread. Додай поле thread.partnerUserId або thread.participantsUserIds[email]=UserID");
      return;
    }
    window.location.href = `${SOFTR_PROFILE_URL}?recordId=${encodeURIComponent(partnerUserId)}`;
  };

  // === SEND TEXT ===
  sendBtn.onclick = sendMessage;
  input.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });

  async function sendMessage(){
    const text = input.value.trim();
    if(!text || !meEmail || !threadId) return;
    input.value = "";

    const msgsRef = collection(db, "threads", threadId, "messages");
    await addDoc(msgsRef, {
      text,
      senderEmail: meEmail,
      createdAt: serverTimestamp()
    });
  }

  // === IMAGE (простий варіант: base64 як у твоєму коді) ===
  attachBtn.onclick = () => fileInput.click();
  fileInput.onchange = (e) => handleFileUpload(e);

  function handleFileUpload(e){
    const file = e.target.files?.[0];
    if(!file || !meEmail || !threadId) return;

    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = async () => {
      const msgsRef = collection(db, "threads", threadId, "messages");
      await addDoc(msgsRef, {
        imageUrl: reader.result,
        senderEmail: meEmail,
        createdAt: serverTimestamp()
      });
      e.target.value = "";
    };
  }

  function renderMessage(data){
    const row = document.createElement('div');
    const mine = (data.senderEmail === meEmail);
    row.className = `msg-row ${mine ? 'mine' : 'theirs'}`;

    let content = "";
    if(data.imageUrl){
      content += `<img src="${data.imageUrl}">`;
    }
    if(data.text){
      content += data.imageUrl ? `<div style="margin-top:6px">${escapeHtml(data.text)}</div>` : escapeHtml(data.text);
    }

    row.innerHTML = `<div class="msg">${content}</div>`;
    msgBox.appendChild(row);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
</script>
</body>
</html>
