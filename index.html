<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qura Chat</title>
    <style>
        body { margin: 0; background: #0d1117; font-family: sans-serif; color: #e6edf3; display: flex; flex-direction: column; height: 100vh; }
        #header { padding: 15px; background: #161b22; border-bottom: 1px solid #30363d; font-weight: bold; text-align: center; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .mine { align-self: flex-end; background: #238636; color: white; border-bottom-right-radius: 2px; }
        .theirs { align-self: flex-start; background: #21262d; border-bottom-left-radius: 2px; }
        #input-area { padding: 10px; background: #161b22; display: flex; gap: 10px; border-top: 1px solid #30363d; }
        input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #30363d; background: #0d1117; color: white; outline: none; }
        button#send { background: #1f6feb; color: white; border: none; padding: 0 20px; border-radius: 20px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="header">Завантаження...</div>
<div id="messages"></div>
<div id="input-area">
    <input type="text" id="msg-input" placeholder="Напиши повідомлення..." autocomplete="off">
    <button id="send">Send</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, limit } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ТВОЇ КЛЮЧІ
    const firebaseConfig = {
        apiKey: "AIzaSyBQNxVaRBgyiM0oJJjzDJ5MJi1WBVPlsdI",
        authDomain: "quradating777.firebaseapp.com",
        projectId: "quradating777",
        storageBucket: "quradating777.firebasestorage.app",
        messagingSenderId: "723638199684",
        appId: "1:723638199684:web:b00ea1895fd5b7ee63e9d1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const params = new URLSearchParams(window.location.search);
    const myEmail = params.get('me');
    const partnerEmail = params.get('partner');
    const msgBox = document.getElementById('messages');

    // Перевірка: чи є в посиланні пошти
    if (!myEmail || !partnerEmail) {
        document.getElementById('header').innerText = "Помилка";
        msgBox.innerHTML = '<div style="text-align:center; padding:20px; color:#ff4444">Це посилання працює тільки через кнопку в додатку!</div>';
    } else {
        document.getElementById('header').innerText = `Чат з ${partnerEmail}`;
        initChat();
    }

    function initChat() {
        const q = query(
            collection(db, "messages"),
            where("participants", "array-contains", myEmail),
            orderBy("createdAt", "asc"),
            limit(50)
        );

        onSnapshot(q, (snapshot) => {
            msgBox.innerHTML = '';
            snapshot.forEach((doc) => {
                const data = doc.data();
                if (data.participants.includes(partnerEmail)) {
                    const div = document.createElement('div');
                    div.className = `msg ${data.sender === myEmail ? 'mine' : 'theirs'}`;
                    div.textContent = data.text;
                    msgBox.appendChild(div);
                }
            });
            msgBox.scrollTop = msgBox.scrollHeight;
        });

        document.getElementById('send').onclick = sendMessage;
        document.getElementById('msg-input').addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendMessage();
        });

        async function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;
            try {
                await addDoc(collection(db, "messages"), {
                    text: text,
                    sender: myEmail,
                    participants: [myEmail, partnerEmail],
                    createdAt: serverTimestamp()
                });
                input.value = '';
            } catch (e) { alert("Помилка: " + e.message); }
        }
    }
</script>
</body>
</html>
