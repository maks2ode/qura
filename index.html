<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc,
    collection, addDoc, query, orderBy, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import {
    getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // ✅ ВСТАВ СВІЙ РЕАЛЬНИЙ CONFIG (НЕ PASTE_HERE)
  const firebaseConfig = {
    apiKey: "AIzaSyBQNxVaRBgyiM0oJJjzDJ5MJi1WBVPlsdI",
    authDomain: "quradating777.firebaseapp.com",
    projectId: "quradating777",
    storageBucket: "quradating777.firebasestorage.app",
    messagingSenderId: "723638199684",
    appId: "1:723638199684:web:b00ea1895fd5b7ee63e9d1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const params = new URLSearchParams(window.location.search);
  const partnerId = params.get("partnerId");

  const chatTitle = document.getElementById("chat-title");
  const avatarPhoto = document.getElementById("avatar-photo");
  const avatarChar = document.getElementById("avatar-char");
  const msgBox = document.getElementById("messages");

  function fail(msg){
    console.error(msg);
    alert(msg);
  }

  // 1) Обробка redirect login (якщо був)
  await getRedirectResult(auth).catch(()=>{});

  // 2) Якщо не залогінений у Firebase — робимо redirect login (один раз)
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      const provider = new GoogleAuthProvider();
      await signInWithRedirect(auth, provider);
      return;
    }

    const myEmail = (user.email || "").toLowerCase();
    if (!myEmail) return fail("Нема email у Firebase auth. Перевір Google provider.");

    // 3) Дістаємо мій userId з колекції emails/{email}.userId
    const myEmailRef = doc(db, "emails", myEmail);
    const myEmailSnap = await getDoc(myEmailRef);

    if (!myEmailSnap.exists()) {
      return fail(`Нема відповідності emails/${myEmail} → userId. Додай документ у Firestore.`);
    }

    const myId = String(myEmailSnap.data().userId || "");
    if (!myId) return fail(`emails/${myEmail} не має поля userId`);

    if (!partnerId) return fail("Нема partnerId в URL");

    // 4) Підтягнути партнера з users/{partnerId} і показати фото/ім'я
    const partnerRef = doc(db, "users", String(partnerId));
    const partnerSnap = await getDoc(partnerRef);

    if (partnerSnap.exists()) {
      const p = partnerSnap.data();
      const name = p.name || `User ${partnerId}`;
      chatTitle.textContent = name;

      if (p.photo) {
        avatarPhoto.src = p.photo;
        avatarPhoto.style.display = "block";
        avatarChar.style.display = "none";
      } else {
        avatarChar.textContent = name.charAt(0).toUpperCase();
        avatarChar.style.display = "flex";
        avatarPhoto.style.display = "none";
      }
    } else {
      chatTitle.textContent = `User ${partnerId}`;
      avatarChar.textContent = "U";
      avatarChar.style.display = "flex";
      avatarPhoto.style.display = "none";
    }

    // 5) chatId стабільний для пари (ID+ID)
    const chatId = [String(myId), String(partnerId)].sort().join("_");

    // 6) Створимо/оновимо чат-док з members (для rules/безпеки)
    await setDoc(doc(db, "chats", chatId), {
      members: [String(myId), String(partnerId)],
      updatedAt: serverTimestamp()
    }, { merge: true });

    // 7) Історія
    const msgsRef = collection(db, "chats", chatId, "messages");
    const q = query(msgsRef, orderBy("createdAt", "asc"));

    onSnapshot(q, (snap) => {
      msgBox.innerHTML = "";
      snap.forEach((d) => {
        const m = d.data();
        const row = document.createElement("div");
        row.className = `msg-row ${m.senderId === String(myId) ? "mine" : "theirs"}`;
        row.innerHTML = `<div class="msg">${(m.text || "")}</div>`;
        msgBox.appendChild(row);
      });
      msgBox.scrollTop = msgBox.scrollHeight;
    }, (err) => fail("onSnapshot error: " + err.message));

    // 8) Надсилання
    document.getElementById("send-btn").onclick = async () => {
      const input = document.getElementById("msg-input");
      const text = input.value.trim();
      if (!text) return;

      await addDoc(msgsRef, {
        text,
        senderId: String(myId),
        createdAt: serverTimestamp()
      });

      input.value = "";
    };
  });
</script>
