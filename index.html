<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInAnonymously
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  import {
    getFirestore,
    doc,
    getDoc,
    collection,
    addDoc,
    query,
    orderBy,
    onSnapshot,
    limit,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const SOFTR_PROFILE_URL = "https://quradating.softr.app/user-profile";

  const firebaseConfig = {
    apiKey: "AIzaSyBQNxVaRBgyiM0oJJjzDJ5MJi1WBVPlsdI",
    authDomain: "quradating777.firebaseapp.com",
    projectId: "quradating777",
    storageBucket: "quradating777.firebasestorage.app",
    messagingSenderId: "723638199684",
    appId: "1:723638199684:web:b00ea1895fd5b7ee63e9d1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // ---- URL params ----
  const params = new URLSearchParams(window.location.search);
  const partnerId = params.get("partnerId");   // MUST: number/string like "1"
  const myEmail = params.get("me");            // MUST: like "admin@test.com"
  const myId = (myEmail || "").trim().toLowerCase(); // we use email as id

  // ---- UI elements ----
  const chatTitle = document.getElementById("chat-title");
  const avatarChar = document.getElementById("avatar-char");
  const avatarPhoto = document.getElementById("avatar-photo");
  const msgBox = document.getElementById("messages");

  // quick guard
  if (!partnerId || !myId) {
    chatTitle.innerText = "Помилка URL";
    avatarChar.innerText = "!";
    msgBox.innerHTML = `<div style="color:#aaa; padding:12px;">
      Немає параметрів у URL.<br><br>
      Треба: <b>?partnerId=1&me=admin@test.com</b>
    </div>`;
    throw new Error("Missing partnerId or me");
  }

  // chatId = stable key for the pair (me + partnerId)
  const chatId = [myId, String(partnerId)].sort().join("__");

  // ---- helpers ----
  function setHeaderNameAndAvatar(name, photoUrl) {
    chatTitle.innerText = name || `User ${partnerId}`;

    const first = (name || `U`).trim().charAt(0).toUpperCase() || "U";
    avatarChar.innerText = first;

    // try to show photo if exists
    if (photoUrl) {
      avatarPhoto.src = photoUrl;
      avatarPhoto.style.display = "block";
      avatarChar.style.display = "none";

      // if photo url can't be embedded -> fallback to letter
      avatarPhoto.onerror = () => {
        avatarPhoto.style.display = "none";
        avatarChar.style.display = "flex";
      };
    } else {
      avatarPhoto.style.display = "none";
      avatarChar.style.display = "flex";
    }
  }

  // ---- load partner profile from Firestore /users/{partnerId} ----
  async function loadPartnerProfile() {
    try {
      const snap = await getDoc(doc(db, "users", String(partnerId)));
      if (snap.exists()) {
        const data = snap.data();
        setHeaderNameAndAvatar(data?.name, data?.photo);
      } else {
        setHeaderNameAndAvatar(`User ${partnerId}`, null);
      }
    } catch (e) {
      setHeaderNameAndAvatar(`User ${partnerId}`, null);
    }
  }

  // ---- render messages ----
  function renderMessage(data) {
    const row = document.createElement("div");
    row.className = `msg-row ${data.senderId === myId ? "mine" : "theirs"}`;

    const time =
      data.createdAt?.toDate
        ? new Date(data.createdAt.toDate()).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
        : "";

    let content = "";
    if (data.imageUrl) {
      content += `<img src="${data.imageUrl}" onclick="event.stopPropagation(); window.viewImage('${data.imageUrl}')">`;
    }
    if (data.text) {
      content += data.imageUrl ? `<div style="margin-top:6px">${data.text}</div>` : data.text;
    }

    row.innerHTML = `
      <div class="msg">
        ${content}
        <span style="display:block; font-size:10px; opacity:0.7; text-align:right; margin-top:5px;">${time}</span>
      </div>`;
    msgBox.appendChild(row);
  }

  // ---- listen chat history ----
  function startChatListener() {
    const q = query(
      collection(db, "chats", chatId, "messages"),
      orderBy("createdAt", "asc"),
      limit(100)
    );

    onSnapshot(q, (snapshot) => {
      msgBox.innerHTML = "";
      snapshot.forEach((d) => renderMessage(d.data()));
      setTimeout(() => (msgBox.scrollTop = msgBox.scrollHeight), 50);
    });
  }

  // ---- send message ----
  async function sendMessage() {
    const input = document.getElementById("msg-input");
    const text = (input.value || "").trim();
    if (!text) return;

    input.value = "";

    await addDoc(collection(db, "chats", chatId, "messages"), {
      text,
      senderId: myId,
      senderEmail: myId,
      partnerId: String(partnerId),
      createdAt: serverTimestamp()
    });
  }

  // ---- wire UI ----
  document.getElementById("send-btn").onclick = sendMessage;
  document.getElementById("msg-input").onkeypress = (e) => {
    if (e.key === "Enter") sendMessage();
  };

  // profile click (optional, if you pass pid later)
  document.getElementById("profile-link").onclick = () => {
    // if you later add ?pid= in URL, you can redirect
    const pid = params.get("pid");
    if (pid) window.location.href = `${SOFTR_PROFILE_URL}?recordId=${pid}`;
  };

  // ---- IMPORTANT: make auth non-null WITHOUT popup ----
  onAuthStateChanged(auth, async (user) => {
    try {
      if (!user) await signInAnonymously(auth); // silent auth
      await loadPartnerProfile();
      startChatListener();
    } catch (e) {
      chatTitle.innerText = "Auth error";
      msgBox.innerHTML = `<div style="color:#aaa; padding:12px;">
        Firebase Auth не зміг увійти (Anonymous).<br>
        Перевір: Authentication → Sign-in method → Anonymous = Enabled.
      </div>`;
      console.error(e);
    }
  });

  // image viewer (kept from your UI)
  window.viewImage = (src) => {
    document.getElementById("viewer-img").src = src;
    document.getElementById("img-viewer").style.display = "flex";
  };
</script>
